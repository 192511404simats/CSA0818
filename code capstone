import sqlite3
from datetime import datetime
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
import os
import webbrowser

# ------------------------------
# ğŸ“¦ Database Setup
# ------------------------------
conn = sqlite3.connect("saving_goals.db")
cursor = conn.cursor()

cursor.execute("""
CREATE TABLE IF NOT EXISTS goals (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    target_amount REAL NOT NULL,
    current_amount REAL DEFAULT 0,
    reminder_date TEXT,
    reminder_time TEXT
)
""")
conn.commit()

# ------------------------------
# ğŸ›  Function to check database structure
# ------------------------------
def check_db_structure():
    cursor.execute("PRAGMA table_info(goals)")
    columns = cursor.fetchall()
    if len(columns) != 6:
        print("âš ï¸ Database structure outdated. Recreating new database...")
        conn.close()
        os.remove("saving_goals.db")
        os.system("python " + __file__)
        exit()

check_db_structure()

# ------------------------------
# â• Add a new goal
# ------------------------------
def add_goal():
    name = input("Enter goal name: ")
    target = float(input("Enter target amount: "))
    current = float(input("Enter current amount (0 if none): "))
    reminder_date = input("Enter reminder date (YYYY-MM-DD): ")
    reminder_time = input("Enter reminder time (HH:MM): ")
    cursor.execute("""
        INSERT INTO goals (name, target_amount, current_amount, reminder_date, reminder_time)
        VALUES (?, ?, ?, ?, ?)
    """, (name, target, current, reminder_date, reminder_time))
    conn.commit()
    print(f"âœ… Goal '{name}' added successfully!\n")

# ------------------------------
# ğŸ‘€ View all goals
# ------------------------------
def view_goals():
    cursor.execute("SELECT id, name, target_amount, current_amount, reminder_date, reminder_time FROM goals")
    goals = cursor.fetchall()
    if not goals:
        print("No goals found.\n")
        return
    print("\nğŸ¯ Your Saving Goals:")
    for g in goals:
        id, name, target, current, r_date, r_time = g
        progress = (current / target) * 100 if target else 0
        print(f"ID: {id} | {name} | Target: â‚¹{target:.2f} | Current: â‚¹{current:.2f} | Progress: {progress:.1f}% | Reminder: {r_date} {r_time}")
    print()

# ------------------------------
# âœï¸ Update goal amount
# ------------------------------
def update_goal():
    view_goals()
    goal_id = int(input("Enter Goal ID to update: "))
    add_amt = float(input("Enter amount to add: "))
    cursor.execute("UPDATE goals SET current_amount = current_amount + ? WHERE id = ?", (add_amt, goal_id))
    conn.commit()
    print("âœ… Goal updated successfully!\n")

# ------------------------------
# ğŸ”” Check reminders
# ------------------------------
def check_reminders():
    now = datetime.now().strftime("%Y-%m-%d %H:%M")
    cursor.execute("SELECT name FROM goals WHERE reminder_date || ' ' || reminder_time = ?", (now,))
    reminders = cursor.fetchall()
    if reminders:
        print("ğŸ”” Reminder Alert!")
        for r in reminders:
            print(f"Don't forget your goal: {r[0]}")
        print()
    else:
        print("No reminders right now.\n")

# ------------------------------
# ğŸ“„ Generate and Auto-Open PDF Report
# ------------------------------
def generate_pdf_report():
    cursor.execute("SELECT id, name, target_amount, current_amount, reminder_date, reminder_time FROM goals")
    goals = cursor.fetchall()
    if not goals:
        print("No goals to include in report.\n")
        return

    try:
        # âœ… Create â€œReportsâ€ folder on Desktop
        desktop = os.path.join(os.path.expanduser("~"), "Desktop")
        report_folder = os.path.join(desktop, "SavingGoalReports")
        os.makedirs(report_folder, exist_ok=True)

        # âœ… Set full path for PDF file
        pdf_filename = os.path.join(report_folder, "Saving_Goals_Report.pdf")

        # âœ… Generate PDF
        c = canvas.Canvas(pdf_filename, pagesize=letter)
        c.setFont("Helvetica-Bold", 16)
        c.drawString(200, 760, "ğŸ’° Saving Goals Report")

        c.setFont("Helvetica", 12)
        c.drawString(100, 740, f"Generated on: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

        y = 700
        for g in goals:
            id, name, target, current, r_date, r_time = g
            progress = (current / target) * 100 if target else 0
            c.drawString(100, y, f"ID: {id} | {name} | Target: â‚¹{target:.2f} | Current: â‚¹{current:.2f} | Progress: {progress:.1f}%")
            c.drawString(100, y - 15, f"Reminder: {r_date} {r_time}")
            y -= 40

            if y < 80:
                c.showPage()
                c.setFont("Helvetica", 12)
                y = 750

        c.save()

        # âœ… Show success and open PDF
        print(f"\nâœ… PDF Report saved successfully at: {pdf_filename}")
        webbrowser.open_new(pdf_filename)

    except Exception as e:
        print(f"âŒ Error generating PDF: {e}")

# ------------------------------
# ğŸ§­ Main Menu
# ------------------------------
def main_menu():
    while True:
        print("========= ğŸ’° Saving Goal Tracker =========")
        print("1. Add Goal")
        print("2. View Goals")
        print("3. Update Goal")
        print("4. Check Reminders")
        print("5. Generate PDF Report")
        print("6. Exit")
        choice = input("Enter choice (1-6): ")

        if choice == "1":
            add_goal()
        elif choice == "2":
            view_goals()
        elif choice == "3":
            update_goal()
        elif choice == "4":
            check_reminders()
        elif choice == "5":
            generate_pdf_report()
        elif choice == "6":
            print("Goodbye! ğŸ‘‹")
            break
        else:
            print("âŒ Invalid choice. Try again.\n")

# ------------------------------
# ğŸš€ Run Program
# ------------------------------
if __name__ == "__main__":
    main_menu()
